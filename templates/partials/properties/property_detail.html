{% load static %}

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">{{ property.name }}</h1>

        <!-- Image Carousel/Gallery -->
        {% if property.images.all %}
            <div x-data="{ 
                currentIndex: 0,
                images: {{ property.images.all|length }},
                nextImage() {
                    this.currentIndex = (this.currentIndex + 1) % this.images;
                },
                previousImage() {
                    this.currentIndex = (this.currentIndex - 1 + this.images) % this.images;
                },
                goToImage(index) {
                    this.currentIndex = index;
                }
            }" 
            @keydown.arrow-left.window="previousImage()"
            @keydown.arrow-right.window="nextImage()"
            class="carousel-container position-relative mb-4" 
            tabindex="0">
                
                <!-- Main Image Display -->
                <div class="carousel-main-image">
                    {% for img in property.images.all %}
                        <img src="{{ img.image.url }}"
                             alt="Property image {{ forloop.counter }}"
                             class="img-fluid w-100 rounded"
                             x-show="currentIndex === {{ forloop.counter0 }}"
                             x-cloak>
                    {% endfor %}
                </div>

                <!-- Navigation Buttons -->
                {% if property.images.all|length > 1 %}
                    <button @click="previousImage()"
                            class="carousel-btn carousel-btn-prev btn btn-dark position-absolute top-50 start-0 translate-middle-y ms-2"
                            aria-label="Previous image"
                            type="button">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    
                    <button @click="nextImage()"
                            class="carousel-btn carousel-btn-next btn btn-dark position-absolute top-50 end-0 translate-middle-y me-2"
                            aria-label="Next image"
                            type="button">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                {% endif %}

                <!-- Image Counter -->
                <div class="carousel-counter position-absolute bottom-0 end-0 bg-dark bg-opacity-75 text-white px-3 py-1 m-2 rounded">
                    <span x-text="currentIndex + 1"></span> / {{ property.images.all|length }}
                </div>
            </div>

            <!-- Thumbnail Indicators -->
            {% if property.images.all|length > 1 %}
                <div class="carousel-thumbnails d-flex gap-2 mt-3 mb-4 overflow-auto" x-data>
                    {% for image in property.images.all %}
                        <div @click="$dispatch('set-image', {{ forloop.counter0 }})"
                             class="carousel-thumbnail position-relative"
                             role="button"
                             tabindex="0"
                             aria-label="Go to image {{ forloop.counter }}">
                            <img src="{{ image.image.url }}" 
                                 alt="Thumbnail {{ forloop.counter }}"
                                 class="img-thumbnail"
                                 style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;">
                            {% if image.is_primary %}
                                <span class="badge bg-primary position-absolute top-0 start-0 m-1" style="font-size: 0.6rem;">Primary</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% else %}
            <div class="alert alert-info mb-4" role="alert">
                <i class="bi bi-image"></i> No images available for this property.
            </div>
        {% endif %}

        <!-- Property Details Card -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Property Details</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Description</dt>
                    <dd class="col-sm-9">{{ property.description|default:"No description provided" }}</dd>
                    
                    <dt class="col-sm-3">Address</dt>
                    <dd class="col-sm-9">{{ property.full_address }}</dd>
                    
                    <dt class="col-sm-3">Phone Number</dt>
                    <dd class="col-sm-9">{{ property.phone_number }}</dd>
                    
                    <dt class="col-sm-3">CNIC</dt>
                    <dd class="col-sm-9">{{ property.cnic }}</dd>
                    
                    <dt class="col-sm-3">Property Type</dt>
                    <dd class="col-sm-9">{{ property.property_type }}</dd>
                    
                    <dt class="col-sm-3">Price</dt>
                    <dd class="col-sm-9">${{ property.price }}</dd>
                    
                    <dt class="col-sm-3">Published</dt>
                    <dd class="col-sm-9">
                        {% if property.is_published %}
                            <span class="badge bg-success">Yes</span>
                        {% else %}
                            <span class="badge bg-secondary">No</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Created</dt>
                    <dd class="col-sm-9">{{ property.created_at|date:"F j, Y" }}</dd>
                    
                    <dt class="col-sm-3">Owner</dt>
                    <dd class="col-sm-9">{{ property.user.username }}</dd>
                    
                    <dt class="col-sm-3">Document</dt>
                    <dd class="col-sm-9">
                        {% if property.documents %}
                            {% if user.is_authenticated %}
                                <a href="{% url 'properties:download_document' property.id %}" class="btn btn-primary btn-sm">
                                    <i class="bi bi-download"></i> Download Document
                                </a>
                            {% else %}
                                <span class="text-muted">Log in to download the document.</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">No document uploaded.</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 mb-4 flex-wrap">
            {% if user.is_authenticated %}
                <div id="favorite-btn-container">
                    {% include 'partials/properties/favorite_button.html' %}
                </div>
            {% endif %}
            
            {% if is_owner %}
                <a href="{% url 'properties:edit' property.id %}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Edit Property
                </a>
                <button type="button" 
                        class="btn btn-danger"
                        @click="$dispatch('show-delete-modal')"
                        x-data>
                    <i class="bi bi-trash"></i> Delete Property
                </button>
            {% endif %}
            
            <a href="{% url 'properties:list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Properties
            </a>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% if is_owner %}
    {% include 'partials/properties/delete_modal.html' %}
{% endif %}

<style>
    .carousel-container {
        outline: none;
    }

    .carousel-main-image {
        max-height: 500px;
        overflow: hidden;
        background-color: #f8f9fa;
    }

    .carousel-main-image img {
        object-fit: contain;
        max-height: 500px;
    }

    .carousel-btn {
        opacity: 0.7;
        transition: opacity 0.3s;
        z-index: 10;
    }

    .carousel-btn:hover {
        opacity: 1;
    }

    .carousel-thumbnail {
        position: relative;
        flex-shrink: 0;
        transition: transform 0.2s;
    }

    .carousel-thumbnail:hover {
        transform: scale(1.05);
    }

    .carousel-thumbnails {
        scrollbar-width: thin;
    }

    .carousel-thumbnails::-webkit-scrollbar {
        height: 8px;
    }

    .carousel-thumbnails::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .carousel-thumbnails::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .carousel-thumbnails::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
