<div id="property-form-container" 
     x-data="{
         loading: false,
         newImages: [],
         deleteImageIds: [],
         removeDocument: false,
         previewImages(event) {
             const files = Array.from(event.target.files);
             this.newImages = files.map(file => ({
                 url: URL.createObjectURL(file),
                 name: file.name
             }));
         },
         toggleImageDelete(imageId) {
             const index = this.deleteImageIds.indexOf(imageId);
             if (index > -1) {
                 this.deleteImageIds.splice(index, 1);
             } else {
                 this.deleteImageIds.push(imageId);
             }
         },
         isMarkedForDeletion(imageId) {
             return this.deleteImageIds.includes(imageId);
         }
     }">
    
    <form {% if is_edit_mode %}
              hx-post="{% url 'properties:edit' property.pk %}"
          {% else %}
              hx-post="{% url 'properties:create' %}"
          {% endif %}
          hx-encoding="multipart/form-data"
          hx-target="#property-form-container"
          hx-swap="outerHTML"
          @htmx:before-request="loading = true"
          @htmx:after-request="loading = false"
          enctype="multipart/form-data"
          method="post">
        
        {% csrf_token %}
        
        <!-- Display non-field errors -->
        {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            {% for error in form.non_field_errors %}
                {{ error }}
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Property Name -->
        <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">
                {{ form.name.label }}
                {% if form.name.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.name }}
            {% if form.name.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.name.errors.0 }}
                </div>
            {% endif %}
            {% if form.name.help_text %}
                <div class="form-text">{{ form.name.help_text }}</div>
            {% endif %}
        </div>
        
        <!-- Description -->
        <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">
                {{ form.description.label }}
                {% if form.description.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.description }}
            {% if form.description.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.description.errors.0 }}
                </div>
            {% endif %}
            {% if form.description.help_text %}
                <div class="form-text">{{ form.description.help_text }}</div>
            {% endif %}
        </div>
        
        <!-- Full Address -->
        <div class="mb-3">
            <label for="{{ form.full_address.id_for_label }}" class="form-label">
                {{ form.full_address.label }}
                {% if form.full_address.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.full_address }}
            {% if form.full_address.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.full_address.errors.0 }}
                </div>
            {% endif %}
            {% if form.full_address.help_text %}
                <div class="form-text">{{ form.full_address.help_text }}</div>
            {% endif %}
        </div>
        
        <!-- Phone Number -->
        <div class="mb-3">
            <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                {{ form.phone_number.label }}
                {% if form.phone_number.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.phone_number }}
            {% if form.phone_number.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.phone_number.errors.0 }}
                </div>
            {% endif %}
            {% if form.phone_number.help_text %}
                <div class="form-text">{{ form.phone_number.help_text }}</div>
            {% endif %}
        </div>
        
        <!-- CNIC -->
        <div class="mb-3">
            <label for="{{ form.cnic.id_for_label }}" class="form-label">
                {{ form.cnic.label }}
                {% if form.cnic.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.cnic }}
            {% if form.cnic.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.cnic.errors.0 }}
                </div>
            {% endif %}
            {% if form.cnic.help_text %}
                <div class="form-text">{{ form.cnic.help_text }}</div>
            {% endif %}
        </div>
        
        <!-- Property Type -->
        <div class="mb-3">
            <label for="{{ form.property_type.id_for_label }}" class="form-label">
                {{ form.property_type.label }}
                {% if form.property_type.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.property_type }}
            {% if form.property_type.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.property_type.errors.0 }}
                </div>
            {% endif %}
            {% if form.property_type.help_text %}
                <div class="form-text">{{ form.property_type.help_text }}</div>
            {% endif %}
        </div>
        
        <!-- Price -->
        <div class="mb-3">
            <label for="{{ form.price.id_for_label }}" class="form-label">
                {{ form.price.label }}
                {% if form.price.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.price }}
            {% if form.price.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.price.errors.0 }}
                </div>
            {% endif %}
            {% if form.price.help_text %}
                <div class="form-text">{{ form.price.help_text }}</div>
            {% endif %}
        </div>
        
        <!-- Existing Images (Edit Mode) -->
        {% if is_edit_mode and property.images.all %}
        <div class="mb-3">
            <label class="form-label">Existing Images</label>
            <div class="row g-2">
                {% for image in property.images.all %}
                <div class="col-md-3">
                    <div class="card" :class="{ 'border-danger': isMarkedForDeletion({{ image.id }}) }">
                        <img src="{{ image.image.url }}" class="card-img-top" alt="Property image">
                        <div class="card-body p-2">
                            <div class="form-check">
                                <input type="checkbox" 
                                       class="form-check-input" 
                                       :name="'delete_image_ids'"
                                       value="{{ image.id }}"
                                       @change="toggleImageDelete({{ image.id }})"
                                       id="delete-image-{{ image.id }}">
                                <label class="form-check-label" for="delete-image-{{ image.id }}">
                                    Delete
                                </label>
                            </div>
                            {% if image.is_primary %}
                            <span class="badge bg-primary mt-1">Primary</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- New Images Upload -->
        <div class="mb-3">
            <label for="images-upload" class="form-label">
                {% if is_edit_mode %}Add New Images{% else %}Property Images{% endif %}
            </label>
            <input type="file" 
                   class="form-control" 
                   id="images-upload"
                   name="images"
                   multiple
                   accept="image/*"
                   @change="previewImages">
            <div class="form-text">Upload property images (JPEG, PNG, GIF, WebP). Max 5MB per image.</div>
            
            <!-- Image Preview -->
            <div class="row g-2 mt-2" x-show="newImages.length > 0" x-cloak>
                <template x-for="(image, index) in newImages" :key="index">
                    <div class="col-md-3">
                        <div class="card">
                            <img :src="image.url" class="card-img-top" :alt="image.name">
                            <div class="card-body p-2">
                                <small class="text-muted" x-text="image.name"></small>
                                <span x-show="index === 0" class="badge bg-primary ms-1">Primary</span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Document Upload -->
        <div class="mb-3">
            <label for="{{ form.documents.id_for_label }}" class="form-label">
                {{ form.documents.label }}
            </label>
            
            {% if is_edit_mode and property.documents %}
            <div class="mb-2">
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-file-pdf"></i>
                        Current document: <a href="{% url 'properties:download_document' property.pk %}" target="_blank">Download</a>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" 
                               class="form-check-input" 
                               id="remove-document"
                               x-model="removeDocument"
                               name="remove_document"
                               value="true">
                        <label class="form-check-label" for="remove-document">
                            Remove
                        </label>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {{ form.documents }}
            {% if form.documents.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.documents.errors.0 }}
                </div>
            {% endif %}
            {% if form.documents.help_text %}
                <div class="form-text">{{ form.documents.help_text }}</div>
            {% endif %}
        </div>
        
        <!-- Is Published -->
        <div class="mb-3">
            <div class="form-check">
                {{ form.is_published }}
                <label class="form-check-label" for="{{ form.is_published.id_for_label }}">
                    {{ form.is_published.label }}
                </label>
            </div>
            {% if form.is_published.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.is_published.errors.0 }}
                </div>
            {% endif %}
            {% if form.is_published.help_text %}
                <div class="form-text">{{ form.is_published.help_text }}</div>
            {% endif %}
        </div>
        
        <!-- Submit Button -->
        <div class="d-flex gap-2">
            <button type="submit" 
                    class="btn btn-primary"
                    :disabled="loading">
                <span x-show="!loading">
                    {% if is_edit_mode %}
                        <i class="bi bi-save"></i> Update Property
                    {% else %}
                        <i class="bi bi-plus-circle"></i> Create Property
                    {% endif %}
                </span>
                <span x-show="loading" x-cloak>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Saving...
                </span>
            </button>
            
            <a href="{% if is_edit_mode %}{% url 'properties:detail' property.pk %}{% else %}{% url 'properties:list' %}{% endif %}" 
               class="btn btn-secondary">
                Cancel
            </a>
        </div>
    </form>
    
    <!-- Loading Overlay -->
    <div x-show="loading" 
         x-cloak
         class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
         style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>
